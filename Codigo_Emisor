#include <SPI.h>
#include <nRF24L01.h>
#include <RF24.h>
#include <DHT.h>

// Configuraci√≥n del m√≥dulo NRF24L01
#define CE_PIN 10
#define CSN_PIN 9
RF24 radio(CE_PIN, CSN_PIN);

// Configuraci√≥n del sensor DHT11
#define DHTPIN 2
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

const byte address[6] = "00001";

// Estructura para los datos
struct SensorData {
  float temperature;
  float humidity;
  uint32_t packetNumber;
};

uint32_t packetCounter = 0;

void setup() {
  Serial.begin(115200);
  Serial.println("==================================");
  Serial.println("   TRANSMISOR DHT11 + NRF24L01   ");
  Serial.println("==================================");
  
  // Inicializar el sensor DHT
  dht.begin();
  delay(2000);

  // Inicializar el m√≥dulo de radio
  if (!radio.begin()) {
    Serial.println("‚ùå ERROR: M√≥dulo NRF24L01 no responde");
    while(1);
  }
  
  radio.openWritingPipe(address);
  radio.setPALevel(RF24_PA_MAX);
  radio.setDataRate(RF24_250KBPS);
  radio.setRetries(3, 5);
  radio.stopListening();
  
  Serial.println("‚úÖ Transmisor listo");
  Serial.println("üéØ Enviando datos...");
}

void loop() {
  // Leer datos del sensor
  float temp = dht.readTemperature();
  float hum = dht.readHumidity();
  
  // Verificar si las lecturas son v√°lidas
  if (!isnan(temp) && !isnan(hum)) {
    // Preparar datos para env√≠o
    SensorData datos;
    datos.temperature = temp;
    datos.humidity = hum;
    datos.packetNumber = ++packetCounter;
    
    // Enviar datos por RF
    bool enviado = radio.write(&datos, sizeof(datos));
    
    // Mostrar informaci√≥n por serial
    Serial.print("üì§ Paquete #");
    Serial.print(packetCounter);
    Serial.print(" - Temp: ");
    Serial.print(temp, 1);
    Serial.print("¬∞C, Hum: ");
    Serial.print(hum, 0);
    Serial.print("% - ");
    Serial.println(enviado ? "‚úÖ √âxito" : "‚ùå Fall√≥");
    
    // Enviar tambi√©n por JSON para la interfaz web
    Serial.print("{\"temperatura\":");
    Serial.print(temp, 1);
    Serial.print(",\"humedad\":");
    Serial.print(hum, 0);
    Serial.println("}");
    
  } else {
    Serial.println("‚ùå ERROR: Lectura inv√°lida del sensor DHT11");
  }
  
  delay(2000); // Esperar 2 segundos entre lecturas
}
